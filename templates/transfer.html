<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>P2P File Transfer - File Transfer</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css"
    />
  </head>
  <body class="bg-light">
    <div class="container mt-5">
      <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
          <h2>Welcome, {{ user_name }}!</h2>
          <a href="{{ url_for('logout') }}" class="btn btn-danger">Logout</a>
        </div>
      </div>
      <div class="row">
        <div class="col-12">
          <div class="alert alert-info">
            <div class="d-flex align-items-center">
              <div class="flex-grow-1">
                <strong>Your Connection ID: </strong>
                <span id="connectionId" class="user-select-all"
                  >Loading...</span
                >
              </div>
              <button
                class="btn btn-sm btn-outline-primary ms-2"
                onclick="copyConnectionId()"
              >
                <i class="bi bi-clipboard"></i> Copy
              </button>
            </div>
            <small class="text-muted d-block mt-2"
              >Share your Connection ID with others to receive files.</small
            >
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h4>Send File</h4>
            </div>
            <div class="card-body">
              {% with messages = get_flashed_messages() %} {% if messages %} {%
              for message in messages %}
              <div class="alert alert-info">{{ message }}</div>
              {% endfor %} {% endif %} {% endwith %}
              <form id="sendFileForm" onsubmit="return sendFile(event)">
                <div class="mb-3">
                  <label for="target_id" class="form-label"
                    >Target Connection ID</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="target_id"
                    required
                  />
                  <small class="text-muted"
                    >Enter the Connection ID of the recipient</small
                  >
                </div>
                <div class="mb-3">
                  <label for="file" class="form-label">Select File</label>
                  <input type="file" class="form-control" id="file" required />
                </div>
                <div class="progress mb-3 d-none" id="progress">
                  <div
                    class="progress-bar"
                    role="progressbar"
                    style="width: 0%"
                  ></div>
                </div>
                <div class="d-grid">
                  <button type="submit" class="btn btn-primary">
                    Send File
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h4>Received Files</h4>
            </div>
            <div class="card-body">
              <div class="list-group" id="receivedFiles">
                {% for file in received_files %}
                <div class="list-group-item">
                  <div
                    class="d-flex justify-content-between align-items-center"
                  >
                    <div>
                      <h6 class="mb-0">{{ file.filename }}</h6>
                      <small class="text-muted"
                        >Uploaded: {{ file.upload_date.strftime('%Y-%m-%d
                        %H:%M:%S') }}</small
                      >
                    </div>
                    <a
                      href="{{ url_for('download_file', file_id=file.id) }}"
                      class="btn btn-sm btn-primary"
                      >Download</a
                    >
                  </div>
                </div>
                {% else %}
                <div class="text-center text-muted">No files yet</div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script>
      function copyConnectionId() {
        const connectionId =
          document.getElementById("connectionId").textContent;
        navigator.clipboard
          .writeText(connectionId)
          .then(() => {
            // Change button text temporarily to show success
            const button = document.querySelector(
              'button[onclick="copyConnectionId()"]'
            );
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="bi bi-check"></i> Copied!';
            setTimeout(() => {
              button.innerHTML = originalHTML;
            }, 2000);
          })
          .catch((err) => {
            console.error("Failed to copy:", err);
            alert("Failed to copy Connection ID");
          });
      }

      let peer = null;
      let connections = {};

      // Initialize PeerJS
      function initPeer() {
        peer = new Peer();

        peer.on("open", (id) => {
          document.getElementById("connectionId").textContent = id;
        });

        peer.on("connection", (conn) => {
          connections[conn.peer] = conn;
          setupConnection(conn);
        });

        peer.on("error", (err) => {
          console.error("PeerJS error:", err);
          alert("Connection error: " + err.message);
        });
      }

      // Setup connection handlers
      function setupConnection(conn) {
        let fileChunks = [];
        let currentFileName = "";
        let currentFileType = "";

        conn.on("data", (data) => {
          if (data.type === "file-start") {
            // File transfer starting
            fileChunks = [];
            currentFileName = data.filename;
            createProgressBar(data.filename);
          } else if (data.type === "file-chunk") {
            // Update progress and store chunk
            fileChunks.push(data.chunk);
            updateProgress(currentFileName, data.progress);
          } else if (data.type === "file-complete") {
            // File transfer complete
            currentFileType = data.fileType;
            const blob = new Blob(fileChunks, { type: currentFileType });
            saveFile(blob, currentFileName);
            removeProgressBar(currentFileName);

            // Reset variables
            fileChunks = [];
            currentFileName = "";
            currentFileType = "";
          }
        });

        conn.on("error", (err) => {
          console.error("Connection error:", err);
          alert("Bağlantı hatası: " + err.message);
        });
      }

      // Send file function
      async function sendFile(event) {
        event.preventDefault();

        const targetId = document.getElementById("target_id").value;
        const fileInput = document.getElementById("file");
        const file = fileInput.files[0];

        if (!file) {
          alert("Please select a file");
          return false;
        }

        let conn = connections[targetId];
        if (!conn) {
          conn = peer.connect(targetId);
          connections[targetId] = conn;
          setupConnection(conn);

          // Wait for connection to be established
          await new Promise((resolve) => {
            conn.on("open", resolve);
          });
        }

        // Show progress bar
        const progress = document.getElementById("progress");
        progress.classList.remove("d-none");
        const progressBar = progress.querySelector(".progress-bar");

        // Start file transfer
        conn.send({
          type: "file-start",
          filename: file.name,
        });

        // Read and send file in chunks
        const chunkSize = 16384;
        const chunks = [];
        const reader = new FileReader();
        let offset = 0;

        reader.onload = (e) => {
          const chunk = e.target.result;
          chunks.push(chunk);

          conn.send({
            type: "file-chunk",
            chunk: chunk,
            progress: Math.min(100, (offset / file.size) * 100),
          });

          offset += chunk.byteLength;
          progressBar.style.width = `${Math.min(
            100,
            (offset / file.size) * 100
          )}%`;

          if (offset < file.size) {
            // Read next chunk
            readChunk();
          } else {
            // Transfer complete
            conn.send({
              type: "file-complete",
              chunks: chunks,
              filename: file.name,
              fileType: file.type,
            });

            // Hide progress bar
            setTimeout(() => {
              progress.classList.add("d-none");
              progressBar.style.width = "0%";
            }, 1000);
          }
        };

        function readChunk() {
          const slice = file.slice(offset, offset + chunkSize);
          reader.readAsArrayBuffer(slice);
        }

        // Start reading
        readChunk();
        return false;
      }

      // Save received file
      function saveFile(blob, filename) {
        const receivedFiles = document.getElementById("receivedFiles");
        const listItem = document.createElement("div");
        listItem.className = "list-group-item";

        // Create object URL for the file
        const url = URL.createObjectURL(blob);

        const currentTime = new Date().toLocaleString("tr-TR");

        listItem.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0">${filename}</h6>
                        <small class="text-muted">Alındı: ${currentTime}</small>
                    </div>
                    <div>
                        <button onclick="downloadFile('${url}', '${filename}')" class="btn btn-sm btn-primary">İndir</button>
                    </div>
                </div>
            `;

        // Eğer "No files yet" mesajı varsa onu kaldır
        const noFilesMessage = receivedFiles.querySelector(
          ".text-center.text-muted"
        );
        if (noFilesMessage) {
          noFilesMessage.remove();
        }

        receivedFiles.insertBefore(listItem, receivedFiles.firstChild);
      }

      // Download file function
      function downloadFile(url, filename) {
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }

      // Progress bar functions
      function createProgressBar(filename) {
        const receivedFiles = document.getElementById("receivedFiles");
        const existingProgress = document.getElementById(
          `progress-${filename}`
        );

        // Remove existing progress bar if it exists
        if (existingProgress) {
          existingProgress.remove();
        }

        const progressDiv = document.createElement("div");
        progressDiv.className = "progress mb-2";
        progressDiv.id = `progress-${filename}`;
        progressDiv.innerHTML = `
                <div class="progress-bar" role="progressbar" style="width: 0%">
                    ${filename} alınıyor...
                </div>
            `;
        receivedFiles.insertBefore(progressDiv, receivedFiles.firstChild);
      }

      function updateProgress(filename, progress) {
        const progressDiv = document.getElementById(`progress-${filename}`);
        if (progressDiv) {
          const progressBar = progressDiv.querySelector(".progress-bar");
          if (progressBar) {
            progressBar.style.width = `${progress}%`;
            progressBar.textContent = `${filename} alınıyor... ${Math.round(
              progress
            )}%`;
          }
        }
      }

      function removeProgressBar(filename) {
        const progressDiv = document.getElementById(`progress-${filename}`);
        if (progressDiv) {
          setTimeout(() => {
            progressDiv.remove();
          }, 1000);
        }
      }

      // Initialize PeerJS when page loads
      window.addEventListener("load", initPeer);
    </script>
  </body>
</html>
